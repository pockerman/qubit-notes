# qubit-note: FastAPI Series | Create a Middleware for FastAPI

## Overview

Very often our application requires to pre-process a request before handling it. A common theme for example is checking
user credentials or authorization to perform a certain action. 

In this qubit-note we will see how to create middlewares with FastAPI. We will be following the 
official documentation: <a href="https://fastapi.tiangolo.com/tutorial/middleware/">Middleware</>

**keywords:** FastAPI, Programming, Python, Web-applications

## Create a Middleware for FastAPI

As per [1]:

_A "middleware" is a function that works with every request before it is processed by any specific path operation. And also with every response before returning it._
A middleware accepts an incoming request, processes it and then handles to the further processed by the rest of the application.
Typically, the middleware contains code that is needed to be executed by all paths in our application before the request is actually handled e.g. examine security
credentials. The middleware also takes the response generated by the application executes code on that response and then it returns the response.

Now that we know what a middleware is, let's see how to create one. To create a middleware you use the decorator ```@app.middleware("http")``` on top of a function.
Here is a simple example taken from FastAPI documentation in [1]:

```
import time

from fastapi import FastAPI, Request

app = FastAPI()


@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.perf_counter()
    response = await call_next(request)
    process_time = time.perf_counter() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

FastAPI supports multiple middleware execution order. That is you can add multiple middlewares using either ```@app.middleware()``` decorator or ```app.add_middleware()``` method.
Each new middleware wraps the application, forming a stack. The last middleware added is the outermost, and the first is the innermost.
The created middlewares are executed differently depending on whether we handle the request or the response. For example assume the following two middleware:

```
app.add_middleware(MiddlewareA)
app.add_middleware(MiddlewareB)
```

This will result in the execution order shown below:

- Request: MiddlewareB → MiddlewareA → route
- Response: route → MiddlewareA → MiddlewareB

Stacking of middleware is useful for obvious reasons but bear in mind that it can significantly affect the performance of our application.


## Summary

Middleware in FastAPI is used to preprocess every incoming request and postprocess every outgoing response, enabling cross-cutting functionality such as authentication, authorization, logging, or timing. A middleware intercepts requests before they reach route handlers, passes them along for further processing, and can modify the response before it is returned to the client. In FastAPI, middleware is created using the ```@app.middleware("http")``` decorator or by adding middleware programmatically with ```app.add_middleware()```. FastAPI supports multiple middlewares arranged in a stack, where the order of addition determines execution order: the last added middleware runs first on requests and last on responses. While middleware stacking is powerful, excessive use can impact application performance.

## References

1. <a href="https://fastapi.tiangolo.com/tutorial/middleware/">Middleware</>